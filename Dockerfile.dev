FROM dunglas/frankenphp:1-php8.3

# Install system dependencies and PHP extensions.
# opcache is intentionally excluded: without it PHP re-reads source files from disk
# on every worker boot, ensuring hot-reload via the Caddyfile watch directive is reliable.
# pcntl is required by Laravel Octane; xdebug for development debugging.
# BuildKit cache mounts keep apt lists and IPE downloads between builds.
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    --mount=type=cache,target=/tmp/ipe-cache,sharing=locked \
    apt-get update && apt-get install -y --no-install-recommends \
    unzip \
    && IPE_CACHE_DIR=/tmp/ipe-cache install-php-extensions \
    pcntl \
    xdebug

# Install Node.js for Vite asset building
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && apt-get install -y --no-install-recommends \
    nodejs \
    npm

COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

WORKDIR /app

ENV APP_ENV=local
ENV APP_DEBUG=1
ENV XDEBUG_MODE=off

COPY docker/frankenphp/Caddyfile.dev /etc/caddy/Caddyfile
COPY docker/frankenphp/xdebug.ini /usr/local/etc/php/conf.d/xdebug.ini
COPY docker/frankenphp/entrypoint.dev.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

EXPOSE 80

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["php", "artisan", "octane:frankenphp", "--host=0.0.0.0", "--port=80", "--workers=1", "--max-requests=250"]
